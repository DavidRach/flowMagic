<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Documentation • flowMagic</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Documentation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">flowMagic</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.99.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Documentation.html">Documentation</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/semontante/flowMagic/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Documentation</h1>
                        <h4 data-toc-skip class="author">Sebastiano
Montante</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/semontante/flowMagic/blob/HEAD/vignettes/Documentation.rmd" class="external-link"><code>vignettes/Documentation.rmd</code></a></small>
      <div class="d-none name"><code>Documentation.rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="abstract">Abstract<a class="anchor" aria-label="anchor" href="#abstract"></a>
</h2>
<p>This pdf describes the usage of the main flowMagic functions and
reports examples of typical flowMagic scripts. Each function usually
contains many parameters, only few of them are mentioned in this
document. A detailed documentation of each parameter for each function
can be found on the flowMagic manual.pdf document in the pkg manual
github directory.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>The easiest way to install owMagic is directly from github:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"semontante/flowMagic"</span>,ref<span class="op">=</span><span class="st">"main"</span><span class="op">)</span></span></code></pre></div>
<p>The user can also download the package locally and install it from
the package folder:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"path/to/flowMagic.tar.gz"</span>,repos<span class="op">=</span><span class="cn">NULL</span>,type<span class="op">=</span><span class="st">"source"</span><span class="op">)</span></span></code></pre></div>
<p>The following libraries are required:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/sp/" class="external-link">sp</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel" class="external-link">doParallel</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stat.berkeley.edu/~breiman/RandomForests/" class="external-link">randomForest</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/topepo/caret/" class="external-link">caret</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://joelgombin.github.io/concaveman/" class="external-link">concaveman</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">sm</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">pracma</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">stats</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">grDevices</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://davidrach.github.io/flowMagic/">flowMagic</a></span><span class="op">)</span></span></code></pre></div>
<p>Note that flowMagic requires an old version of the sf package. In
particular, flowMagic was tested on R 3.5.2 with the sf package version
0.7.2. It is highly recommended to use the provided docker container
where all the required packages are installed.</p>
</div>
<div class="section level2">
<h2 id="input">Input<a class="anchor" aria-label="anchor" href="#input"></a>
</h2>
<p>There are 2 types of input: ungated data to analyze and the trained
model to use for gating. The ungated data is within a directory
containing the bivariate marker expression of the images under analysis.
In particular, the marker expression must be reported in a csv file
whose first and second column report the expression of, respectively,
the first and second marker. Each row refers to the expression of a
single event/cell. Here’s an example of a correctly formatted csv
file:</p>
<pre><code><span><span class="co">##   PE-CF594-A FITC-A</span></span>
<span><span class="co">## 1      2.985  3.137</span></span>
<span><span class="co">## 2      2.433  2.752</span></span>
<span><span class="co">## 3      2.942  2.914</span></span>
<span><span class="co">## 4      2.874  3.121</span></span>
<span><span class="co">## 5      1.805  2.119</span></span>
<span><span class="co">## 6      1.925  2.712</span></span>
<span><span class="co">## 7      0.871  2.560</span></span>
<span><span class="co">## 8      2.782  2.836</span></span>
<span><span class="co">## 9      2.645  2.265</span></span></code></pre>
<p>The trained model can be either a templates model or a generalized
model. The template model is needed to automatically gate the data based
on the patterns de ned by the user. The training data to generate this
model is extracted by the user from the data to analyze containing the
same combination of markers. The generalized model is trained on a large
FCMdataset containing di erent combinations of markers extracted from di
erent projects unrelated to the dataset under analysis. The owMagic
package includes a generalized model in the inst/data folder trained on
the Project Discovery data. The users can train their own generalized
model if they manage to generate a large dataset of FCM data with di
erent combinations of markers. Both the template model and the
generalized model require the training data in csv format with 3 columns
for each csv le to train. Each csv le represents the bivariate marker
expression ( rst and second column) associated with the gates (the third
column, which is also classes column). Each numerical label indicates a
di erent gate. Note that the 0 label always indicates the background
events. In other words, they are events with no gate.</p>
<pre><code><span><span class="co">##   PE-CF594-A FITC-A Classes</span></span>
<span><span class="co">## 1      2.985  3.137       1</span></span>
<span><span class="co">## 2      2.433  2.752       2</span></span>
<span><span class="co">## 3      2.942  2.914       2</span></span>
<span><span class="co">## 4      2.874  3.121       1</span></span>
<span><span class="co">## 5      1.805  2.119       0</span></span>
<span><span class="co">## 6      1.925  2.712       0</span></span>
<span><span class="co">## 7      0.871  2.560       1</span></span>
<span><span class="co">## 8      2.782  2.836       1</span></span>
<span><span class="co">## 9      2.645  2.265       1</span></span></code></pre>
<p>The next sections show an example of automated gating using the
template model and an example of gating using the generalized model.</p>
</div>
<div class="section level2">
<h2 id="automated-gating-using-the-template-model">Automated gating using the template model<a class="anchor" aria-label="anchor" href="#automated-gating-using-the-template-model"></a>
</h2>
<p>First, it is necessary to import the ungated data using the import
test set csv function. The user needs to indicate the path to a
directory containing all unlabeled csv les under analysis. If there are
more than two columns, the function will import only the rst two
columns. The user can also parallelize the importing process using more
cores.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">list_test_data</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/import_test_set_csv.html">import_test_set_csv</a></span><span class="op">(</span>path_data <span class="op">=</span> <span class="st">"path/to/data"</span>, n_cores<span class="op">=</span><span class="fl">8</span><span class="op">)</span></span></code></pre></div>
<p>list test data is a list in which each element is a dataframe of two
columns containing the bivariate marker expression of each CSV le. To
generate the template model it is necessary to import the reference data
to use for training. The user needs to provide the path to the directory
containing the labeled csv les. The CSV les need to contain 3 columns
with the third column reporting the labels of each event.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">list_data_ref</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/import_reference_csv.html">import_reference_csv</a></span><span class="op">(</span>path_results <span class="op">=</span> <span class="st">"path/to/data"</span>,n_cores <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span></code></pre></div>
<p>list data ref is also a list of dataframes. This list is the input of
the pre-processing function needed to prepare the data for training. The
get train data function generates the correctly formatted training set
from the raw reference data, extracting the density features needed for
the training. The function includes several parameters. For example, the
user can choose the number of cores to speed up the pre-processing or
they can choose to perform a downsampling of the data. By default, the
function considers 90% of the input data. The data is also normalized by
default, the user can also choose to disable normalization. If there are
bivariate plots with extreme outliers, like sparse events in an angle of
the plot, disabling normalization may improve accuracy.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># normalized data, no downsampling</span></span>
<span><span class="va">ref_train</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/get_train_data.html">get_train_data</a></span><span class="op">(</span>paths_file <span class="op">=</span> <span class="va">list_data_ref</span>,n_cores <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># normalized data, yes downsampling</span></span>
<span><span class="va">ref_train</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/get_train_data.html">get_train_data</a></span><span class="op">(</span>paths_file <span class="op">=</span> <span class="va">list_data_ref</span>,prop_down <span class="op">=</span> <span class="fl">0.90</span>, n_cores <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="co"># consider only 90\% of the events for each plot.</span></span>
<span></span>
<span><span class="va">ref_train</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/get_train_data.html">get_train_data</a></span><span class="op">(</span>paths_file <span class="op">=</span> <span class="va">list_data_ref</span>,n_points_per_plot <span class="op">=</span> <span class="fl">500</span>, n_cores <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="co"># consider only 500 points for each plot.</span></span>
<span></span>
<span><span class="co"># no normalized data, no downsampling</span></span>
<span> <span class="va">ref_train</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/get_train_data.html">get_train_data</a></span><span class="op">(</span>paths_file <span class="op">=</span> <span class="va">list_data_ref</span>,n_cores <span class="op">=</span> <span class="fl">8</span>, normalize_data<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Then, the user needs to select the indices of the train set and
validation set for the cross-validation method to perform during
training. There are multiple possible methods, see the appropriate
function documentation for the complete list of the methods. Below it is
shown an example that performs the leave-out-out cross-validation.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">list_inds_cross_val</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/get_indices_cross_val.html">get_indices_cross_val</a></span><span class="op">(</span>df_train <span class="op">=</span> <span class="va">ref_train</span>,</span>
<span>train_inds <span class="op">=</span> <span class="st">"leave_one_out"</span>,val_inds <span class="op">=</span> <span class="st">"leave_one_out"</span><span class="op">)</span></span></code></pre></div>
<p>After this, the training can begin. The user can choose the model to
use for training. Each model has di erent parameters with their own
default values that the users can change. The random forest with the
default number of trees (n trees=10) is used by default:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ref_model_info</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/magicTrain.html">magicTrain</a></span><span class="op">(</span>df_train <span class="op">=</span> <span class="va">ref_train</span>,train_model <span class="op">=</span> <span class="st">"rf"</span>,</span>
<span>list_index_train <span class="op">=</span> <span class="va">list_inds_cross_val</span><span class="op">$</span><span class="va">inds_train</span>,list_index_val <span class="op">=</span> <span class="va">list_inds_cross_val</span><span class="op">$</span><span class="va">inds_val</span><span class="op">)</span></span></code></pre></div>
<p>In case of one template or 2 templates, it is suggested to use the
out-of-bag cross validation which is the default cross validation method
in these cases. Note that the user does not need to input the
cross-validation indices when using the out-of-bag method.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ref_model_info</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/magicTrain.html">magicTrain</a></span><span class="op">(</span>df_train <span class="op">=</span> <span class="va">ref_train</span>,train_model <span class="op">=</span> <span class="st">"rf"</span>,</span>
<span> method_control<span class="op">=</span><span class="st">"oob"</span><span class="op">)</span></span></code></pre></div>
<p>Finally, the prediction step can be performed. The user needs to
provide the unlabeled data imported at the beginning and the trained
model. If the user also provides the pre-processed data used for
training (the previous ref train variable), the prediction function can
also calculate the template-target distance for further analysis.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">list_dfs_pred</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/magicPred_all.html">magicPred_all</a></span><span class="op">(</span>list_test_data <span class="op">=</span> <span class="va">list_test_data</span>, ref_model_info <span class="op">=</span> <span class="va">ref_model_info</span>,ref_data_train <span class="op">=</span> <span class="va">ref_train</span><span class="op">)</span></span></code></pre></div>
<p>The list dfs pred variable is a nested list. Each element of the list
contains the prediction information related to one plot. Each prediction
information consists of a list of several dataframes and other outputs
referring to di erent steps of the prediction process for one plot. The
most important dataframe is the dataframe reporting the predicted labels
associated with each events of the input original data.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Selecting the final dataframe of the first gated plot.</span></span>
<span><span class="co"># The third column contains the predicted labels.</span></span>
<span><span class="va">df_temp</span><span class="op">&lt;-</span><span class="va">list_dfs_pred</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">final_df</span></span></code></pre></div>
<p>See the appropriate function documentation for details on the other
outputs. If the user provided the pre-processed training set used for
training, the vec dist slot will contain the vector of target-template
distances for each plot used as template. The other dataframes of each
nested element refer to the gating of the downsampled data (in case
downsampling is applied during the prediction step) or the normalized
data. No downsampling is applied by default when using the template
model. The downsampling is applied by default only when using the
generalized model.</p>
</div>
<div class="section level2">
<h2 id="automated-gating-using-the-generalized-model">Automated gating using the generalized model<a class="anchor" aria-label="anchor" href="#automated-gating-using-the-generalized-model"></a>
</h2>
<p>To apply the generalized model, the user can use the same prediction
function described in the previous section. The only di erence is
related to the arguments used. There are two models to use in this case.
Model A predicts the number of gates in the plot, while Model B predicts
the gates boundaries based on the predicted number of gates. There is a
di erent Model B for each possible number of gates (e.g., Model B.2
predicts the two gates boundaries, Model B.3 predicts 3 gates
boundaries). The magic model argument requires the list of Model B for
each number of gates, while the magic model n gates requires Model A.
Based on the value predicted by Model A, the appropriate Model B.X is
used from the list of Model B. The owMagic R package already provides
these two types of models.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_pred</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/magicPred_all.html">magicPred_all</a></span><span class="op">(</span>test_data <span class="op">=</span> <span class="va">list_test_data</span>,magic_model <span class="op">=</span> <span class="va">list_magic_models</span>, magic_model_n_gates <span class="op">=</span> <span class="va">random_forest_model_pred_n_gates_index</span>, n_cores <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span></code></pre></div>
<p>The users can also generate their own generalized model using the
owMagic training function as described in the next section. It is also
possible to force the function to predict a pre-de ned number of gates.
It is su cient to replace the number of gates model with an integer
indicating the number of gates. The appropriate Model B will be selected
from the list of Model B provided.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_pred</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/magicPred_all.html">magicPred_all</a></span><span class="op">(</span>test_data <span class="op">=</span> <span class="va">list_test_data</span>,magic_model <span class="op">=</span> <span class="va">list_magic_models</span>,magic_model_n_gates <span class="op">=</span> <span class="fl">3</span>,n_cores</span>
<span> <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="co"># to predict boundaries associated to 3 gates.</span></span>
<span> <span class="va">out_pred</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/magicPred_all.html">magicPred_all</a></span><span class="op">(</span>test_data <span class="op">=</span> <span class="va">list_test_data</span>,magic_model <span class="op">=</span> <span class="va">list_magic_models</span>,magic_model_n_gates <span class="op">=</span> <span class="fl">4</span>,n_cores</span>
<span> <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="co"># to predict boundaries associated to 4 gates.</span></span></code></pre></div>
<p>Finally, it is also possible to provide a single model predicting
directly the gate boundaries.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_pred</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/magicPred_all.html">magicPred_all</a></span><span class="op">(</span>test_data <span class="op">=</span> <span class="va">list_test_data</span>,magic_model <span class="op">=</span> <span class="va">single_model</span>,magic_model_n_gates <span class="op">=</span> <span class="cn">NULL</span>,n_cores <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span></code></pre></div>
<p>By default, when applying the generalized model, the data is
downsampled to 500 points to speed up execution. In addition, the number
of events considered need to be consistent with the downsampling
performed during the training of the generalized model. The polygons
calculated in the downsampled data will be overlapped on the original
data to get the true number of events for each gate. See the function
documentation for the details of each argument.</p>
</div>
<div class="section level2">
<h2 id="example-of-full-scripts-using-either-template-or-generalized-model">Example of full scripts using either template or generalized
model<a class="anchor" aria-label="anchor" href="#example-of-full-scripts-using-either-template-or-generalized-model"></a>
</h2>
<p>Example of correct script using the template model</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co">#loadlibraries</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a> <span class="fu">library</span>(sp)</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a> <span class="fu">library</span>(stringr)</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a> <span class="fu">library</span>(ggplot2)</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a> <span class="fu">library</span>(parallel)</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a> <span class="fu">library</span>(doParallel)</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a> <span class="fu">library</span>(randomForest)</span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a> <span class="fu">library</span>(caret)</span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a> <span class="fu">library</span>(concaveman)</span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a> <span class="fu">library</span>(sm)</span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a> <span class="fu">library</span>(pracma)</span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a> <span class="fu">library</span>(sf)</span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a> <span class="fu">library</span>(stats)</span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a> <span class="fu">library</span>(grDevices)</span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a> <span class="fu">library</span>(flowMagic)</span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a> <span class="co">#------------using template model with1template</span></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a> <span class="co">#getpathto directorywith files toanalyze</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a> path_dir<span class="ot">&lt;-</span><span class="fu">system.file</span>(<span class="st">"extdata"</span>,<span class="at">package =</span><span class="st">"flowMagic"</span>)</span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a> <span class="co">#importdatawithlabelsthatwe useastemplatedata.</span></span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a> list_data_ref<span class="ot">&lt;-</span><span class="fu">import_reference_csv</span>(<span class="at">path_results=</span>path_dir,<span class="at">n_cores=</span><span class="dv">1</span>)</span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a> <span class="co">#importdatawithoutlabels</span></span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a> list_test_data<span class="ot">&lt;-</span><span class="fu">import_test_set_csv</span>(<span class="at">path_data=</span> path_dir,<span class="at">n_cores=</span><span class="dv">1</span>)</span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a> <span class="co">#Notethatit is possible toprovidealsodirectlythepathstoeachfile.Seefunctionsmanualforadditional</span></span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a> details.</span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a> <span class="co">#datapreprocessingtogeneratetemplatemodel usingfirstfileastemplate</span></span>
<span id="cb17-26"><a href="#cb17-26" tabindex="-1"></a> ref_train<span class="ot">&lt;-</span><span class="fu">get_train_data</span>(<span class="at">paths_file =</span>list_data_ref[<span class="dv">1</span>],<span class="at">n_cores=</span><span class="dv">1</span>) <span class="co">#weselectfirstelementoftheimportedlist</span></span>
<span id="cb17-27"><a href="#cb17-27" tabindex="-1"></a> ofdataframes</span>
<span id="cb17-28"><a href="#cb17-28" tabindex="-1"></a> <span class="co">#generatethetemplatemodelusingout-of-the-bagvalidation</span></span>
<span id="cb17-29"><a href="#cb17-29" tabindex="-1"></a> ref_model_info<span class="ot">&lt;-</span><span class="fu">magicTrain</span>(<span class="at">df_train=</span>ref_train,<span class="at">n_cores =</span><span class="dv">1</span>,<span class="at">train_model=</span> <span class="st">"rf"</span>)</span>
<span id="cb17-30"><a href="#cb17-30" tabindex="-1"></a> <span class="co">#performautomatedgating(gatesboundariesprediction step)</span></span>
<span id="cb17-31"><a href="#cb17-31" tabindex="-1"></a> list_dfs_pred<span class="ot">&lt;-</span><span class="fu">magicPred_all</span>(<span class="at">list_test_data=</span> list_test_data,<span class="at">magic_model=</span><span class="cn">NULL</span>,<span class="at">ref_data_train=</span> ref_train,</span>
<span id="cb17-32"><a href="#cb17-32" tabindex="-1"></a> <span class="at">ref_model_info =</span>ref_model_info,<span class="at">n_cores=</span><span class="dv">8</span>)</span>
<span id="cb17-33"><a href="#cb17-33" tabindex="-1"></a> <span class="co">#Notethatprovidingthetrainingsetin themagicPred function is optional (ref_data_train=ref_trainisoptional).</span></span>
<span id="cb17-34"><a href="#cb17-34" tabindex="-1"></a> <span class="co">#Providingthe trainingsetallowstheuserto calculate the target-templatedistanceforeachplot to analyze.</span></span>
<span id="cb17-35"><a href="#cb17-35" tabindex="-1"></a> <span class="co">#list_dfs_pred containsalistofdataframesforeachplotanalyzed.Inother words, itisanestedlist(e.g.,</span></span>
<span id="cb17-36"><a href="#cb17-36" tabindex="-1"></a> downsampleddatasetandoriginaldatasetwithpredictedlabelsforeachplot<span class="er">)</span>.Seethefunctionsmanualforthe</span>
<span id="cb17-37"><a href="#cb17-37" tabindex="-1"></a> fulllistofdataframesreturned.</span>
<span id="cb17-38"><a href="#cb17-38" tabindex="-1"></a> <span class="co">#visualizegateddata</span></span>
<span id="cb17-39"><a href="#cb17-39" tabindex="-1"></a> df_temp<span class="ot">&lt;-</span>list_dfs_pred[[<span class="dv">1</span>]]<span class="sc">$</span>df_test_original <span class="co">#dataframe offirstgatedplot</span></span>
<span id="cb17-40"><a href="#cb17-40" tabindex="-1"></a> <span class="fu">magicPlot</span>(<span class="at">df =</span>df_temp,<span class="at">type =</span><span class="st">"ML"</span>,<span class="at">size_points =</span> <span class="dv">1</span>)</span>
<span id="cb17-41"><a href="#cb17-41" tabindex="-1"></a> <span class="fu">magicPlot</span>(<span class="at">df =</span>df_temp,<span class="at">type =</span><span class="st">"dens"</span>,<span class="at">size_points=</span> <span class="dv">1</span>)</span>
<span id="cb17-42"><a href="#cb17-42" tabindex="-1"></a> <span class="co">#------------using template model withmultiple templates</span></span>
<span id="cb17-43"><a href="#cb17-43" tabindex="-1"></a> <span class="co">#getpathto directorywith files toanalyze</span></span>
<span id="cb17-44"><a href="#cb17-44" tabindex="-1"></a> path_dir<span class="ot">&lt;-</span><span class="fu">system.file</span>(<span class="st">"extdata"</span>,<span class="at">package =</span><span class="st">"flowMagic"</span>)</span>
<span id="cb17-45"><a href="#cb17-45" tabindex="-1"></a> <span class="co">#importdatawithlabelsthatwe useastemplatedata.</span></span>
<span id="cb17-46"><a href="#cb17-46" tabindex="-1"></a> list_data_ref<span class="ot">&lt;-</span><span class="fu">import_reference_csv</span>(<span class="at">path_results=</span>path_dir,<span class="at">n_cores=</span><span class="dv">1</span>)</span>
<span id="cb17-47"><a href="#cb17-47" tabindex="-1"></a> <span class="co">#importdatawithoutlabels</span></span>
<span id="cb17-48"><a href="#cb17-48" tabindex="-1"></a> list_test_data<span class="ot">&lt;-</span><span class="fu">import_test_set_csv</span>(<span class="at">path_data=</span> path_dir,<span class="at">n_cores=</span><span class="dv">1</span>)</span>
<span id="cb17-49"><a href="#cb17-49" tabindex="-1"></a></span>
<span id="cb17-50"><a href="#cb17-50" tabindex="-1"></a><span class="co">#Notethatit is possible toprovidealsodirectlythepathstoeachfile.Seefunctionsmanualforadditional</span></span>
<span id="cb17-51"><a href="#cb17-51" tabindex="-1"></a> details.</span>
<span id="cb17-52"><a href="#cb17-52" tabindex="-1"></a> <span class="co">#datapreprocessingforgeneratetemplatemodelusingmultipletemplates</span></span>
<span id="cb17-53"><a href="#cb17-53" tabindex="-1"></a> ref_train<span class="ot">&lt;-</span><span class="fu">get_train_data</span>(<span class="at">paths_file =</span>list_data_ref,<span class="at">n_cores=</span> <span class="dv">1</span>) <span class="co">#weselectallelementsoftheimportedlistof</span></span>
<span id="cb17-54"><a href="#cb17-54" tabindex="-1"></a> dataframes</span>
<span id="cb17-55"><a href="#cb17-55" tabindex="-1"></a> <span class="co">#indicesforleave-one-outcross-validation when training multipletemplates.</span></span>
<span id="cb17-56"><a href="#cb17-56" tabindex="-1"></a> list_inds_cross_val<span class="ot">&lt;-</span><span class="fu">get_indices_cross_val</span>(<span class="at">df_train=</span>ref_train,<span class="at">n_cores=</span><span class="dv">8</span>,<span class="at">train_inds=</span><span class="st">"leave_one_out"</span>,</span>
<span id="cb17-57"><a href="#cb17-57" tabindex="-1"></a> <span class="at">val_inds=</span><span class="st">"leave_one_out"</span>)</span>
<span id="cb17-58"><a href="#cb17-58" tabindex="-1"></a> <span class="co">#generatetemplatemodelusingleave-one-outcrossvalidation validation.</span></span>
<span id="cb17-59"><a href="#cb17-59" tabindex="-1"></a> ref_model_info<span class="ot">&lt;-</span><span class="fu">magicTrain</span>(<span class="at">df_train=</span>ref_train,<span class="at">n_cores =</span><span class="dv">8</span>,<span class="at">train_model=</span> <span class="st">"rf"</span>,</span>
<span id="cb17-60"><a href="#cb17-60" tabindex="-1"></a> <span class="at">list_index_train =</span>list_inds_cross_val<span class="sc">$</span>inds_train,<span class="at">list_index_val=</span>list_inds_cross_val<span class="sc">$</span>inds</span>
<span id="cb17-61"><a href="#cb17-61" tabindex="-1"></a> _val)</span>
<span id="cb17-62"><a href="#cb17-62" tabindex="-1"></a> <span class="co">#performautomatedgating(gatesboundariesprediction step)</span></span>
<span id="cb17-63"><a href="#cb17-63" tabindex="-1"></a> list_dfs_pred<span class="ot">&lt;-</span><span class="fu">magicPred_all</span>(<span class="at">list_test_data=</span> list_test_data,<span class="at">magic_model=</span><span class="cn">NULL</span>,<span class="at">ref_data_train=</span> ref_train,</span>
<span id="cb17-64"><a href="#cb17-64" tabindex="-1"></a> <span class="at">ref_model_info =</span>ref_model_info,<span class="at">n_cores=</span><span class="dv">8</span>)</span>
<span id="cb17-65"><a href="#cb17-65" tabindex="-1"></a> <span class="co">#visualizegateddata</span></span>
<span id="cb17-66"><a href="#cb17-66" tabindex="-1"></a> df_temp<span class="ot">&lt;-</span>list_dfs_pred[[<span class="dv">1</span>]]<span class="sc">$</span>df_test_original <span class="co">#dataframe offirstgatedplot</span></span>
<span id="cb17-67"><a href="#cb17-67" tabindex="-1"></a> <span class="fu">magicPlot</span>(<span class="at">df =</span>df_temp,<span class="at">type =</span><span class="st">"ML"</span>,<span class="at">size_points =</span> <span class="dv">1</span>)</span>
<span id="cb17-68"><a href="#cb17-68" tabindex="-1"></a> <span class="fu">magicPlot</span>(<span class="at">df =</span>df_temp,<span class="at">type =</span><span class="st">"dens"</span>,<span class="at">size_points=</span> <span class="dv">1</span>)</span></code></pre></div>
<p><strong>Example of correct script using the generalized
model.</strong></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="co">#loadlibraries</span></span>
<span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/sp/" class="external-link">sp</a></span><span class="op">)</span></span>
<span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel" class="external-link">doParallel</a></span><span class="op">)</span></span>
<span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stat.berkeley.edu/~breiman/RandomForests/" class="external-link">randomForest</a></span><span class="op">)</span></span>
<span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/topepo/caret/" class="external-link">caret</a></span><span class="op">)</span></span>
<span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://joelgombin.github.io/concaveman/" class="external-link">concaveman</a></span><span class="op">)</span></span>
<span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">sm</span><span class="op">)</span></span>
<span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">pracma</span><span class="op">)</span></span>
<span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">stats</span><span class="op">)</span></span>
<span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">grDevices</span><span class="op">)</span></span>
<span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://davidrach.github.io/flowMagic/">flowMagic</a></span><span class="op">)</span></span>
<span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://davidrach.github.io/flowMagic/">flowMagic</a></span><span class="op">)</span></span>
<span> <span class="co">#Thefirststepis todownload thetrainedgeneralized model (Model AandlistofModelB)from x.</span></span>
<span> <span class="co">#extractthetar.gzfileandload the models.</span></span>
<span> <span class="va">model_a</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"./training_rf_index_3000train10val_2ntree_500points_100folds_31000_consensus_plots_pred_n_gates.</span></span>
<span><span class="st"> RData"</span><span class="op">)</span></span>
<span> <span class="va">model_b_list</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"./list_models_all_n_gates.RData"</span><span class="op">)</span></span>
<span> <span class="co">#getpathto directorywith files toanalyze</span></span>
<span> <span class="va">path_dir</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,package <span class="op">=</span><span class="st">"flowMagic"</span><span class="op">)</span></span>
<span> <span class="co">#importdatawithoutlabels</span></span>
<span> <span class="va">list_test_data</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/import_test_set_csv.html">import_test_set_csv</a></span><span class="op">(</span>path_data<span class="op">=</span> <span class="va">path_dir</span>,n_cores<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span> <span class="co">#performautomatedgating(gatesboundariesprediction step)</span></span>
<span> <span class="va">list_dfs_pred</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/magicPred_all.html">magicPred_all</a></span><span class="op">(</span>list_test_data<span class="op">=</span> <span class="va">list_test_data</span>,magic_model<span class="op">=</span><span class="va">model_b_list</span>,</span>
<span> magic_model_n_gates <span class="op">=</span> <span class="va">model_a</span>,n_cores<span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span> <span class="co">#visualizegateddata</span></span>
<span> <span class="va">df_temp</span><span class="op">&lt;-</span><span class="va">list_dfs_pred</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">df_test_original</span> <span class="co">#dataframe offirstgatedplot</span></span>
<span> <span class="fu"><a href="../reference/magicPlot.html">magicPlot</a></span><span class="op">(</span>df <span class="op">=</span><span class="va">df_temp</span>,type <span class="op">=</span><span class="st">"ML"</span>,size_points <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span> <span class="fu"><a href="../reference/magicPlot.html">magicPlot</a></span><span class="op">(</span>df <span class="op">=</span><span class="va">df_temp</span>,type <span class="op">=</span><span class="st">"dens"</span>,size_points<span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>As mentioned previously, it is possible to generate your own
generalized model by following the instructions provided in the
appropriate section(see generalized model training section).</p>
</div>
<div class="section level2">
<h2 id="generalized-model-training-only-exper-users">Generalized model training (only exper users)<a class="anchor" aria-label="anchor" href="#generalized-model-training-only-exper-users"></a>
</h2>
<p>This section is related to users with experience in training machine
learning algorithms. Users with no machine learning experience can skip
this section. In order to generate the generalized model it is required
to import the dataset to use for training.The get train data function
generates the correctly formatted training set from the raw reference
data,extracting the density features needed for the training.The input
can either be the list of labeled dataframes(with the third column
indicating thelabel assigned to each event) or the paths that lead to
the labeled data. Since the data required to train the generalized model
is usually very large, providing the paths maybe the best option instead
of importing the raw data in to memory.The paths format can either be a
vector of paths pointing directly to the labeled dataframe or a
two-columns data frame with the first column indicating the path to the
expression data and the second column indicating the path tothe labels
of each event. Note that the data is normalized by default. Since the
data for the generalized model is usually verylarge in size, it is
suggested to perform a 500 points downsampling orsimilar to avoid
overcoming the machine memory and speed the training.This is also the
default option.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="va">df_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_train_data.html">get_train_data</a></span><span class="op">(</span>df_paths<span class="op">=</span><span class="va">df_paths</span>,n_cores <span class="op">=</span><span class="fl">1</span>,n_points_per_plot<span class="op">=</span> <span class="fl">500</span><span class="op">)</span> <span class="co"># using dataframes of paths and 500 points downsampling.</span></span>
<span> <span class="va">df_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_train_data.html">get_train_data</a></span><span class="op">(</span>paths_file<span class="op">=</span><span class="va">vec_paths</span>,n_cores <span class="op">=</span><span class="fl">1</span>,n_points_per_plot<span class="op">=</span> <span class="fl">500</span><span class="op">)</span><span class="co"># using vector of paths to labeled dataframes and 500 points downsampling.</span></span></code></pre></div>
<p>As mentioned before, the generalized model is composed of two models:
Model A and Model B. In order to generate Model A, the users need to
provide the data containing plots with a different number of gates. Then
they will need to extract the cross-validation indices selecting the
number of random plots in the training set for each number of gates and
the number of randomplots in the validation set for each number of
gates. The nfolds argument indicates the number of times this process is
repeated. Finally, the users will need to execute the training
indicating the number of gates as response variable.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co"># generate cross-validation indices using 1000 training plots and 50 validation plots for 50 repetitions.</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>list_inds_cross_val<span class="ot">&lt;-</span><span class="fu">get_indices_cross_val</span>(<span class="at">df_train=</span>df_train,<span class="at">n_cores=</span><span class="dv">4</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>    <span class="at">train_inds=</span><span class="st">"rand_set_n_gates_info"</span>, <span class="at">n_train_plots=</span><span class="dv">1000</span>, <span class="at">n_folds=</span><span class="dv">50</span>,</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>    <span class="at">val_inds=</span> <span class="st">"rand_set_n_gates_info"</span>, <span class="at">n_val_plots=</span><span class="dv">50</span>)</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a><span class="co"># generate the generalized model using randomforest.</span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>random_forest_model<span class="ot">&lt;-</span><span class="fu">magicTrain</span>(<span class="at">df_train =</span>df_train, <span class="at">n_cores=</span> <span class="dv">4</span>, <span class="at">train_model=</span><span class="st">"rf"</span>,</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>    <span class="at">list_index_train=</span>list_inds_cross_val<span class="sc">$</span>inds_train,</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>    <span class="at">list_index_val =</span>list_inds_cross_val<span class="sc">$</span>inds_val,<span class="at">n_tree =</span><span class="dv">10</span>,<span class="at">type_y=</span><span class="st">"n_gates_info"</span>)</span></code></pre></div>
<p>In order to generate Model B for the specific number of gates,the
users need to provide the data related to plots having only a specific
number of gates.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Selecting only plots with 2 gates.</span></span>
<span><span class="va">df_train_ngates_selected</span> <span class="op">&lt;-</span> <span class="va">df_train</span><span class="op">[</span><span class="va">df_train</span><span class="op">$</span><span class="va">n_gates_info</span><span class="op">==</span><span class="fl">2</span>,<span class="op">]</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">df_train_ngates_selected</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span></code></pre></div>
<p>Then, the cross-validation indices need to be extracted indicating
the number of random plots in the training set and the number of plots
in the validation set. Finally,the users will need to execute the
training indicating the gates assignment (the classes column) as
response variable.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get cross-validation indices using 300 training plots and 5 validation plots for 50 repetitions.</span></span>
<span> </span>
<span><span class="va">list_inds_cross_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_indices_cross_val.html">get_indices_cross_val</a></span><span class="op">(</span>df_train<span class="op">=</span><span class="va">df_train_ngates_selected</span>,</span>
<span>    n_cores<span class="op">=</span><span class="fl">8</span>, train_inds<span class="op">=</span> <span class="st">"rand_set_num"</span>, n_train_plots<span class="op">=</span> <span class="fl">300</span>, n_folds <span class="op">=</span><span class="fl">100</span>, seed<span class="op">=</span><span class="fl">50</span>,val_inds<span class="op">=</span><span class="st">"rand_set_num"</span>,n_val_plots<span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># generate the generalized model for the gates boundaries of the specific numberof classes.</span></span>
<span><span class="va">random_forest_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/magicTrain.html">magicTrain</a></span><span class="op">(</span>df_train <span class="op">=</span><span class="va">df_train_ngates_selected</span>, n_cores<span class="op">=</span><span class="fl">4</span>,</span>
<span>    train_model<span class="op">=</span><span class="st">"rf"</span>,list_index_train<span class="op">=</span><span class="va">list_inds_cross_val</span><span class="op">$</span><span class="va">inds_train</span>,</span>
<span>    list_index_val<span class="op">=</span> <span class="va">list_inds_cross_val</span><span class="op">$</span><span class="va">inds_val</span>, n_tree <span class="op">=</span><span class="fl">10</span>,</span>
<span>    type_y <span class="op">=</span><span class="st">"classes"</span><span class="op">)</span></span></code></pre></div>
<p>The users can also train a model considering the gates boundaries for
all numbers of gates. In this case, they need to provide the original
complete dataframe containing the plots with all numbers of gates.The
users will need to extract the cross-validation indices selecting the
number of random plots in the training set for each number of gates and
the number of random plots in the validation set for each number of
gates.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#generate cross-validation indices using 1000 training plots and 50 validation plots for 50 repetitions.</span></span>
<span></span>
<span><span class="va">list_inds_cross_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_indices_cross_val.html">get_indices_cross_val</a></span><span class="op">(</span>df_train<span class="op">=</span><span class="va">df_train</span>, n_cores<span class="op">=</span><span class="fl">4</span>,</span>
<span>    train_inds<span class="op">=</span><span class="st">"rand_set_n_gates_info"</span>, n_train_plots<span class="op">=</span><span class="fl">1000</span>, n_folds<span class="op">=</span><span class="fl">50</span>, </span>
<span>    val_inds<span class="op">=</span> <span class="st">"rand_set_n_gates_info"</span>, n_val_plots<span class="op">=</span><span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># generate the generalized model for the gates boundaries for all number of gates.</span></span>
<span><span class="va">random_forest_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/magicTrain.html">magicTrain</a></span><span class="op">(</span>df_train <span class="op">=</span><span class="va">df_train</span>, n_cores <span class="op">=</span><span class="fl">4</span>, train_model<span class="op">=</span><span class="st">"rf"</span>,</span>
<span>    list_index_train <span class="op">=</span><span class="va">list_inds_cross_val</span><span class="op">$</span><span class="va">inds_train</span>, list_index_val<span class="op">=</span> <span class="va">list_inds_cross_val</span><span class="op">$</span><span class="va">inds_val</span>,n_tree <span class="op">=</span><span class="fl">10</span>, type_y <span class="op">=</span><span class="st">"classes"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualizing-options">Visualizing options<a class="anchor" aria-label="anchor" href="#visualizing-options"></a>
</h2>
<p>It is possible to visualize the gated plot using the visualization
framework of the flowMagic package. The magicPlot() function can be used
to plot the scatterplot of the gated plot of interest. It is possible to
visualize the gates assignment on a standard scatterplot (with the
events colored based on their gates) or it is possible to visualize the
polygons on a bivariate density scatterplot.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/magicPlot.html">magicPlot</a></span><span class="op">(</span>df <span class="op">=</span><span class="va">df_temp</span>,type <span class="op">=</span><span class="st">"ML"</span><span class="op">)</span> <span class="co"># gates assignment visualization</span></span>
<span><span class="fu"><a href="../reference/magicPlot.html">magicPlot</a></span><span class="op">(</span>df <span class="op">=</span><span class="va">df_temp</span>,type <span class="op">=</span><span class="st">"dens"</span><span class="op">)</span> <span class="co"># Bivariate density plot with polygons visualization.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="automatically-replicate-pre-defined-hierarchy-gatingset-and-fcs-files">Automatically replicate pre-defined hierarchy: GatingSet and FCS
files<a class="anchor" aria-label="anchor" href="#automatically-replicate-pre-defined-hierarchy-gatingset-and-fcs-files"></a>
</h2>
<p><strong>Note: the functions described in this section have been
tested with flowCore version 1.11.20 and flowWorkspace 0.5.40. Newer
packages may not be compatible with these functions.</strong></p>
<p>flowMagic is also compatible with GatingSet and FCS files. This
format is useful in case the user does not want to generate the csv
files for each gating step. In this mode of execution, flowMagic
automatically trains on each gating step of a predeterminned hierarchy
and automatically gate the FCS files of interest based on the
combinations of markers indicated in the gating hierarchy.The gating
hierarchy information is contained within the GatingSet Robject
generated by the user using the flowWorkspace package. For example, the
users can use flowDensity to gate a speci c number of FCS files and then
they store the gated results in a GatingSet object. Alternatively,the
users can manually gate the FCS files using the FlowJo software and then
they can export a WSP file that flowMagic will automatically convert
into a GatingSet object. This GatingSet object can be used to
automatically generate the template model for each gating step of the
hierarchy. Note: this mode of execution is compatible only with the
template model.The generalized model cannot be used in this mode.</p>
<p>First, the Gating Set needs to be imported.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gs_sample_gated</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/import_gating_info.html">import_gating_info</a></span><span class="op">(</span>path<span class="op">=</span><span class="st">"path/to/data"</span><span class="op">)</span></span>
<span><span class="va">gh_sample_gated_1</span><span class="op">&lt;-</span><span class="va">gs_sample_gated</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="co">#firsttemplate</span></span>
<span><span class="va">gh_sample_gated_2</span><span class="op">&lt;-</span><span class="va">gs_sample_gated</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="co">#secondtemplate.</span></span></code></pre></div>
<p>We also need to import the CSV files to analyze. Note that the FCS
files need to have the same channel names. By default the first FCS is
chosen as reference to check that all channel names are the same.FCS
with channel names different from the chosen reference are excluded.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/import_test_set_fcs.html">import_test_set_fcs</a></span><span class="op">(</span>path<span class="op">=</span></span>
<span>    <span class="st">"/home/rstudio/final_data_test/HIPC_test_data/Myeloid_paneltest_fcs"</span>,</span>
<span>     n_samples<span class="op">=</span><span class="fl">1</span>, ref_f_n<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>Next, we get thet list of training sets for each gating step of the
hierarchy</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="co">#import gating hierarchy from the GatingHierarchy object which contains the gating hierarchy information of the sample.</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a> out <span class="ot">&lt;-</span><span class="fu">get_hierarchy_all_pops</span>(<span class="at">gh=</span>gh_sample_gated_1,<span class="at">export_visnet =</span><span class="cn">FALSE</span>)</span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a><span class="co"># Extract all training data.</span></span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a>list_all_train_sets_1<span class="ot">&lt;-</span><span class="fu">get_local_train_sets</span>(<span class="at">gh=</span>gh_sample_gated_1</span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a>    <span class="at">hierarchical_tree=</span>out<span class="sc">$</span>hierarchical_tree, <span class="at">info_hierarchy=</span>out)</span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a>list_all_train_sets_2<span class="ot">&lt;-</span><span class="fu">get_local_train_sets</span>(<span class="at">gh=</span>gh_sample_gated_2</span>
<span id="cb27-9"><a href="#cb27-9" tabindex="-1"></a>    <span class="at">hierarchical_tree=</span>out<span class="sc">$</span>hierarchical_tree, <span class="at">info_hierarchy=</span>out)</span></code></pre></div>
<p>We also prepate the data to analyze.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">list_all_test_sets</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/get_test_sets.html">get_test_sets</a></span><span class="op">(</span><span class="va">fs</span>,gh<span class="op">=</span><span class="va">gh_sample_gated_1</span><span class="op">)</span></span></code></pre></div>
<p>Finally, the user can execute the training of each training set and
the prediction based on the hierarchy structure.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/magicTrain_hierarchy.html">magicTrain_hierarchy</a></span><span class="op">(</span>list_train_sets <span class="op">=</span> <span class="va">list_all_train_sets_1</span>,n_cores <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">list_models</span> <span class="op">&lt;-</span> <span class="va">out_train</span><span class="op">$</span><span class="va">list_models_sets_all_levels</span></span>
<span></span>
<span><span class="va">list_gated_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/magicPred_hierarchy.html">magicPred_hierarchy</a></span><span class="op">(</span>list_test_sets<span class="op">=</span><span class="va">list_all_test_sets</span>,</span>
<span>    list_models_local <span class="op">=</span> <span class="va">list_models</span>,df_tree <span class="op">=</span> <span class="va">out</span><span class="op">$</span><span class="va">df_tree</span>,n_cores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>The variable list_gated_data contains the labeled dataset for each
gating step.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># extract gated results of the Singlets populations for first example</span></span>
<span></span>
<span><span class="va">df_gated_1</span> <span class="op">&lt;-</span> <span class="va">list_gated_data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span> <span class="va">level</span><span class="op">:</span><span class="fl">6</span> <span class="op">$</span><span class="va">Singlets</span><span class="op">$</span><span class="va">gated_data</span></span>
<span></span>
<span><span class="co"># Visualize gated population.</span></span>
<span><span class="fu"><a href="../reference/magicPlot.html">magicPlot</a></span><span class="op">(</span>df<span class="op">=</span><span class="va">df_gated_1</span>,type <span class="op">=</span> <span class="st">"ML"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.5.1 (2025-06-13 ucrt)</span></span>
<span><span class="co">## Platform: x86_64-w64-mingw32/x64</span></span>
<span><span class="co">## Running under: Windows 11 x64 (build 26100)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">##   LAPACK version 3.12.1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">## [1] LC_COLLATE=English_United States.utf8 </span></span>
<span><span class="co">## [2] LC_CTYPE=English_United States.utf8   </span></span>
<span><span class="co">## [3] LC_MONETARY=English_United States.utf8</span></span>
<span><span class="co">## [4] LC_NUMERIC=C                          </span></span>
<span><span class="co">## [5] LC_TIME=English_United States.utf8    </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: Etc/GMT+5</span></span>
<span><span class="co">## tzcode source: internal</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] parallel  stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">## [8] base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">##  [1] flowMagic_0.99.1     sf_1.0-21            pracma_2.4.6        </span></span>
<span><span class="co">##  [4] sm_2.2-6.0           concaveman_1.2.0     caret_7.0-1         </span></span>
<span><span class="co">##  [7] lattice_0.22-7       randomForest_4.7-1.2 doParallel_1.0.17   </span></span>
<span><span class="co">## [10] iterators_1.0.14     foreach_1.5.2        ggplot2_3.5.2       </span></span>
<span><span class="co">## [13] stringr_1.5.1        sp_2.2-0            </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##   [1] RColorBrewer_1.1-3   jsonlite_1.8.8       magrittr_2.0.3      </span></span>
<span><span class="co">##   [4] farver_2.1.1         rmarkdown_2.29       fs_1.6.6            </span></span>
<span><span class="co">##   [7] ragg_1.4.0           vctrs_0.6.5          htmltools_0.5.8.1   </span></span>
<span><span class="co">##  [10] curl_6.4.0           pROC_1.19.0.1        sass_0.4.10         </span></span>
<span><span class="co">##  [13] parallelly_1.45.1    KernSmooth_2.23-26   bslib_0.9.0         </span></span>
<span><span class="co">##  [16] htmlwidgets_1.6.4    desc_1.4.3           plyr_1.8.9          </span></span>
<span><span class="co">##  [19] plotly_4.11.0        lubridate_1.9.3      cachem_1.1.0        </span></span>
<span><span class="co">##  [22] mime_0.13            lifecycle_1.0.4      pkgconfig_2.0.3     </span></span>
<span><span class="co">##  [25] Matrix_1.7-3         R6_2.6.1             fastmap_1.2.0       </span></span>
<span><span class="co">##  [28] future_1.67.0        shiny_1.11.1         magic_1.6-1         </span></span>
<span><span class="co">##  [31] digest_0.6.35        colorspace_2.1-0     patchwork_1.3.1     </span></span>
<span><span class="co">##  [34] S4Vectors_0.46.0     textshaping_1.0.1    cytolib_2.20.0      </span></span>
<span><span class="co">##  [37] timechange_0.3.0     httr_1.4.7           abind_1.4-8         </span></span>
<span><span class="co">##  [40] compiler_4.5.1       proxy_0.4-27         withr_3.0.2         </span></span>
<span><span class="co">##  [43] DBI_1.2.3            hexbin_1.28.3        MASS_7.3-65         </span></span>
<span><span class="co">##  [46] lava_1.8.2           classInt_0.4-11      ModelMetrics_1.2.2.2</span></span>
<span><span class="co">##  [49] tools_4.5.1          units_1.0-0          httpuv_1.6.16       </span></span>
<span><span class="co">##  [52] future.apply_1.20.0  nnet_7.3-20          glue_1.8.0          </span></span>
<span><span class="co">##  [55] nlme_3.1-168         promises_1.3.3       grid_4.5.1          </span></span>
<span><span class="co">##  [58] Rtsne_0.17           cluster_2.1.8.1      reshape2_1.4.4      </span></span>
<span><span class="co">##  [61] generics_0.1.4       recipes_1.3.1        gtable_0.3.6        </span></span>
<span><span class="co">##  [64] class_7.3-23         tidyr_1.3.1          data.table_1.15.4   </span></span>
<span><span class="co">##  [67] BiocGenerics_0.54.0  pillar_1.11.0        ggExtra_0.11.0      </span></span>
<span><span class="co">##  [70] later_1.4.2          splines_4.5.1        flowCore_2.20.0     </span></span>
<span><span class="co">##  [73] dplyr_1.1.4          survival_3.8-3       RProtoBufLib_2.20.0 </span></span>
<span><span class="co">##  [76] CytoML_2.20.0        tidyselect_1.2.1     RBGL_1.84.0         </span></span>
<span><span class="co">##  [79] ggcyto_1.36.0        miniUI_0.1.2         randomcoloR_1.1.0.1 </span></span>
<span><span class="co">##  [82] knitr_1.50           gridExtra_2.3        V8_6.0.4            </span></span>
<span><span class="co">##  [85] flowWorkspace_4.20.0 stats4_4.5.1         xfun_0.52           </span></span>
<span><span class="co">##  [88] Biobase_2.68.0       hardhat_1.4.2        timeDate_4041.110   </span></span>
<span><span class="co">##  [91] matrixStats_1.5.0    visNetwork_2.1.4     stringi_1.8.3       </span></span>
<span><span class="co">##  [94] ncdfFlow_2.54.0      lazyeval_0.2.2       yaml_2.3.10         </span></span>
<span><span class="co">##  [97] evaluate_1.0.4       codetools_0.2-20     data.tree_1.2.0     </span></span>
<span><span class="co">## [100] tibble_3.2.1         Rgraphviz_2.52.0     graph_1.86.0        </span></span>
<span><span class="co">## [103] cli_3.6.5            rpart_4.1.24         xtable_1.8-4        </span></span>
<span><span class="co">## [106] geometry_0.5.2       systemfonts_1.2.3    jquerylib_0.1.4     </span></span>
<span><span class="co">## [109] Rcpp_1.0.12          globals_0.18.0       XML_3.99-0.16.1     </span></span>
<span><span class="co">## [112] pkgdown_2.1.3        gower_1.0.2          listenv_0.10.0      </span></span>
<span><span class="co">## [115] viridisLite_0.4.2    ipred_0.9-15         scales_1.4.0        </span></span>
<span><span class="co">## [118] prodlim_2025.04.28   e1071_1.7-16         purrr_1.0.2         </span></span>
<span><span class="co">## [121] rlang_1.1.6</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sebastiano Montante.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
